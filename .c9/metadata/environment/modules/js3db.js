{"filter":false,"title":"js3db.js","tooltip":"/modules/js3db.js","undoManager":{"mark":6,"position":6,"stack":[[{"start":{"row":0,"column":0},"end":{"row":52,"column":23},"action":"remove","lines":["/** JS3DB **/","/** JSON AWS S3 DB **/","","const AWS = require(\"aws-sdk\");","const S3 = AWS.S3;","","const s3 = new S3();","","function js3db(dbfile, bucket, callback){","    ","    this.s3 = s3;","    ","    s3.createBucket({Bucket: bucket}, (err, data)=>{","        if(err) console.log(err);","        else {","            console.log(\"Connected to \" + bucket);","            this.create();","            ","            if(typeof callback === \"function\")callback(err, data);","        }","    });","    ","    this.getFileName = () => {","        return dbfile;","    };","    ","    this.write = (obj) => {","        return s3.putObject({Bucket: bucket, Key: dbfile, Body: JSON.stringify(obj)}, function(err, data){","            if(err) console.log(err);","            else console.log(\"Wrote to object: \" + dbfile);","        }).promise();","    };","    ","    this.create = () => {","        s3.putObject({Bucket: bucket, Key: dbfile}, function(err, data){","            if(err) console.log(err);","            else console.log(\"Created object: \" + dbfile);","        });","    };","    ","    this.read = () => {","        return new Promise((resolve, reject) => {","            s3.getObject({Bucket: bucket, Key: dbfile})","                .promise()","                .then(data => {","                    resolve(JSON.parse(data.Body));","                });","        });","    }","    ","}","","module.exports = js3db;"],"id":519},{"start":{"row":0,"column":0},"end":{"row":64,"column":28},"action":"insert","lines":["function AwsAdapter(src, opts){","","    var options = {};","    var aws = {};","    ","    if(opts){","        options = opts;","        aws = opts.aws || {};","    }","    ","    this.src = src || \"db.json\";","    this.defaultValue = options.defaultValue || {};","    this.serialize = obj => {","        return JSON.stringify(obj);","    };","    this.deserialize = obj => {","        return JSON.parse(obj);","    };","    this.contentType = aws.contentType || 'application/json';","    this.cognitoCredentials = aws.cognitoCredentials || false;","    this.bucketName = aws.bucketName || 'lowdb-data';","    this.acl = aws.acl || 'private';","    ","    if (this.cognitoCredentials) {","        options.credentials = new AWS.CognitoIdentityCredentials(","            this.cognitoCredentials","        )","    }","    ","    this.S3 = new S3({ apiVersion: '2006-03-01' });","    ","    this.read = () => {","        var readData = this.defaultValue;","        ","        deasync(this.S3.getObject({","            Bucket: this.bucketName,","            Key: this.src","        }, (err, data) => {","            if(err){","                if(err.code == \"NoSuchKey\"){","                    console.log(\"Error: Could not find \", this.src);","                    this.write(this.defaultValue);","                }else console.log(\"Error: \", err);","            }else{","                readData = this.deserialize(data.Body);","            }","        }));","        ","        return readData;","    };","    ","    this.write = data => {","        this.S3.putObject({","            Body: this.serialize(data),","            Bucket: this.bucketName,","            Key: this.src,","            ContentType: this.contentType,","            ACL: this.acl","        }, function(err, data){","            if(err) console.log(\"Error\", err);","        });","    };","}","","module.exports = AwsAdapter;"]}],[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"insert","lines":["",""],"id":520},{"start":{"row":1,"column":0},"end":{"row":2,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":0,"column":0},"end":{"row":3,"column":35},"action":"insert","lines":["const AWS = require('aws-sdk');","const S3_CLIENT = AWS.S3;","const stringify = obj => JSON.stringify(obj, null, 2);","const deasync = require(\"deasync\");"],"id":521}],[{"start":{"row":69,"column":28},"end":{"row":70,"column":0},"action":"insert","lines":["",""],"id":522},{"start":{"row":70,"column":0},"end":{"row":71,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":71,"column":0},"end":{"row":148,"column":2},"action":"insert","lines":["const AWS = require('aws-sdk');","const S3_CLIENT = AWS.S3;","const stringify = obj => JSON.stringify(obj, null, 2);","const deasync = require(\"deasync\");","const S3FS = require(\"s3fs\");","","module.exports = class {","  constructor(","    source = 'db.json',","    {","      defaultValue = {},","      serialize = stringify,","      deserialize = JSON.parse,","      aws = {}","    } = {}","  ) {","    this.source = source","    this.defaultValue = defaultValue","    this.serialize = serialize","    this.deserialize = deserialize","    this.contentType = aws.contentType || 'application/json'","    this.cognitoCredentials = aws.cognitoCredentials || false","    this.bucketName = aws.bucketName || 'lowdb-data'","    this.acl = aws.acl || 'private'","","    let options = { apiVersion: '2006-03-01' }","","    if (this.cognitoCredentials) {","      options.credentials = new AWS.CognitoIdentityCredentials(","        this.cognitoCredentials","      )","    }","","    this.S3 = new S3_CLIENT(options)","  }","","  read() {","    ","    var readData = this.defaultValue;","    var done = false;","    ","    this.S3.getObject({","        Bucket: this.bucketName,","        Key: this.source","    }, (err, data) => {","        if(err){","            if(err.code == \"NoSuchKey\"){","                console.log(\"Error: Could not find \", this.source);","                this.write(this.defaultValue);","            }else console.log(\"Error: \", err);","        }else{","            //console.log(\"Read object: \", this.source, \"\\nData: \", data.Body);","            readData = this.deserialize(data.Body);","        }","        ","        done=true;","    });","    ","    deasync.loopWhile(function(){ return !done; });","    ","    return readData;","    ","  }","","  write(data) {","      ","    this.S3.putObject({","        Body: this.serialize(data),","        Bucket: this.bucketName,","        Key: this.source,","        ContentType: this.contentType,","        ACL: this.acl","    }, (err, dat) => {","        if(err) console.log(\"Error\", err);","        else console.log(\"Wrote to object: \", this.source, data);","    });","  }","};"],"id":523}],[{"start":{"row":71,"column":0},"end":{"row":71,"column":3},"action":"insert","lines":["// "],"id":525},{"start":{"row":72,"column":0},"end":{"row":72,"column":3},"action":"insert","lines":["// "]},{"start":{"row":73,"column":0},"end":{"row":73,"column":3},"action":"insert","lines":["// "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":3},"action":"insert","lines":["// "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":3},"action":"insert","lines":["// "]}],[{"start":{"row":71,"column":0},"end":{"row":148,"column":2},"action":"remove","lines":["// const AWS = require('aws-sdk');","// const S3_CLIENT = AWS.S3;","// const stringify = obj => JSON.stringify(obj, null, 2);","// const deasync = require(\"deasync\");","// const S3FS = require(\"s3fs\");","","module.exports = class {","  constructor(","    source = 'db.json',","    {","      defaultValue = {},","      serialize = stringify,","      deserialize = JSON.parse,","      aws = {}","    } = {}","  ) {","    this.source = source","    this.defaultValue = defaultValue","    this.serialize = serialize","    this.deserialize = deserialize","    this.contentType = aws.contentType || 'application/json'","    this.cognitoCredentials = aws.cognitoCredentials || false","    this.bucketName = aws.bucketName || 'lowdb-data'","    this.acl = aws.acl || 'private'","","    let options = { apiVersion: '2006-03-01' }","","    if (this.cognitoCredentials) {","      options.credentials = new AWS.CognitoIdentityCredentials(","        this.cognitoCredentials","      )","    }","","    this.S3 = new S3_CLIENT(options)","  }","","  read() {","    ","    var readData = this.defaultValue;","    var done = false;","    ","    this.S3.getObject({","        Bucket: this.bucketName,","        Key: this.source","    }, (err, data) => {","        if(err){","            if(err.code == \"NoSuchKey\"){","                console.log(\"Error: Could not find \", this.source);","                this.write(this.defaultValue);","            }else console.log(\"Error: \", err);","        }else{","            //console.log(\"Read object: \", this.source, \"\\nData: \", data.Body);","            readData = this.deserialize(data.Body);","        }","        ","        done=true;","    });","    ","    deasync.loopWhile(function(){ return !done; });","    ","    return readData;","    ","  }","","  write(data) {","      ","    this.S3.putObject({","        Body: this.serialize(data),","        Bucket: this.bucketName,","        Key: this.source,","        ContentType: this.contentType,","        ACL: this.acl","    }, (err, dat) => {","        if(err) console.log(\"Error\", err);","        else console.log(\"Wrote to object: \", this.source, data);","    });","  }","};"],"id":526},{"start":{"row":71,"column":0},"end":{"row":149,"column":2},"action":"insert","lines":["const AWS = require('aws-sdk');","const S3_CLIENT = AWS.S3;","const stringify = obj => JSON.stringify(obj, null, 2);","const deasync = require(\"deasync\");","const S3FS = require(\"s3fs\");","","module.exports = class {","  constructor(","    source = 'db.json',","    {","      defaultValue = {},","      serialize = stringify,","      deserialize = JSON.parse,","      aws = {}","    } = {}","  ) {","    this.source = source","    this.defaultValue = defaultValue","    this.serialize = serialize","    this.deserialize = deserialize","    this.contentType = aws.contentType || 'application/json'","    this.cognitoCredentials = aws.cognitoCredentials || false","    this.bucketName = aws.bucketName || 'lowdb-data'","    this.acl = aws.acl || 'private'","","    let options = { apiVersion: '2006-03-01' }","","    if (this.cognitoCredentials) {","      options.credentials = new AWS.CognitoIdentityCredentials(","        this.cognitoCredentials","      )","    }","","    this.S3 = new S3_CLIENT(options)","  }","","  read() {","    ","    var readData = this.defaultValue;","    var done = false;","    ","    this.S3.getObject({","        Bucket: this.bucketName,","        Key: this.source","    }, (err, data) => {","        if(err){","            if(err.code == \"NoSuchKey\"){","                console.log(\"Error: Could not find \", this.source);","                this.write(this.defaultValue);","            }else console.log(\"Error: \", err);","        }else{","            //console.log(\"Read object: \", this.source, \"\\nData: \", data.Body);","            readData = this.deserialize(data.Body);","        }","        ","        done=true;","    });","    ","    deasync.loopWhile(function(){ return !done; });","    ","    return readData;","    ","  }","","  write(data) {","      ","    this.S3.putObject({","        Body: this.serialize(data),","        Bucket: this.bucketName,","        Key: this.source,","        ContentType: this.contentType,","        ACL: this.acl","    }, (err, dat) => {","        if(err) console.log(\"Error\", err);","        else console.log(\"Wrote to object: \", this.source, data);","    });","    ","  }","};"]}]]},"ace":{"folds":[],"scrolltop":1825.5,"scrollleft":0,"selection":{"start":{"row":146,"column":7},"end":{"row":146,"column":7},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":1,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1579801215146,"hash":"78839b174fedd22f478a4a62fc2d1778efb4ee30"}